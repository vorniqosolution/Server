<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Invoice - <%= invoice.invoiceNumber %></title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        color: #333;
        line-height: 1.6;
      }
      .invoice-box {
        max-width: 800px;
        margin: auto;
        padding: 30px;
        border: 1px solid #eee;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.15);
      }
      .header {
        text-align: center;
        margin-bottom: 20px;
      }
      .header h1 {
        margin: 0;
        font-weight: 300;
        color: #000;
      }
      .header h2 {
        margin: 0;
        font-size: 1em;
        font-weight: 400;
        color: #555;
      }
      .meta-info {
        border-top: 1px solid #eee;
        border-bottom: 1px solid #eee;
        padding: 10px 0;
        margin-bottom: 30px;
        font-size: 0.9em;
        color: #666;
      }
      .guest-intro {
        background-color: #f7f7f7;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 30px;
      }
      .guest-intro h3 {
        margin-top: 0;
      }
      .guest-intro p {
        margin: 0;
        display: flex;
        justify-content: space-between;
      }
      .section-title {
        border-bottom: 2px solid #333;
        padding-bottom: 5px;
        margin-bottom: 15px;
        font-size: 1.2em;
        font-weight: 600;
      }
      .details-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 40px;
      }
      .info-table {
        width: 100%;
      }
      .info-table td {
        padding: 5px 0;
      }
      .info-table .label {
        font-weight: 600;
        width: 40%;
      }
      .room-details,
      .payment-details {
        margin-top: 20px;
      }
      .billing-summary table {
        width: 100%;
        border-collapse: collapse;
      }
      .billing-summary td {
        padding: 8px 5px;
        border-bottom: 1px solid #eee;
      }
      .billing-summary .amount {
        text-align: right;
      }
      .billing-summary .final-row {
        font-weight: bold;
        font-size: 1.1em;
        background-color: #f7f7f7;
        border-top: 2px solid #ddd;
      }
      .footer {
        text-align: center;
        margin-top: 40px;
        font-size: 0.9em;
        color: #777;
      }
    </style>
  </head>
  <body>
    <% 
      // --- Safely normalize money fields ---
      const effectiveAdvance = typeof invoice.advanceAdjusted === 'number' ? invoice.advanceAdjusted : 0;
      const grandTotal = typeof invoice.grandTotal === 'number' ? invoice.grandTotal : Number(invoice.grandTotal) || 0;
      const balanceDueFromDb = typeof invoice.balanceDue === 'number' ? invoice.balanceDue : null;
      const computedBalanceDue = Math.max(0, grandTotal - effectiveAdvance);
      const balanceDue = balanceDueFromDb === null ? computedBalanceDue : balanceDueFromDb;
      const totalRefunded = typeof invoice.totalRefunded === 'number' ? invoice.totalRefunded : 0;
      const refundDue = Math.max(0, effectiveAdvance - grandTotal);
    %>

    <div class="invoice-box">
      <header class="header">
        <h1>HSQ TOWERS</h1>
        <h2>Premium Hospitality Services</h2>
      </header>

      <section class="meta-info">
        Invoice <strong><%= invoice.invoiceNumber %></strong> &nbsp; | &nbsp;
        Room <strong><%= guest.room.roomNumber %></strong> &nbsp; | &nbsp;
        Generated on
        <strong><%= new Date(invoice.issueDate || invoice.createdAt).toLocaleString('en-US') %></strong>
      </section>

      <section class="guest-intro">
        <h3><%= guest.fullName %></h3>
        <p>
          <span>Guest ID: <%= guest._id.toString().slice(-8).toUpperCase() %></span>
          <span style="font-weight: bold; color: <%= guest.status === 'checked-in' ? 'green' : '#555' %>">
            <%= guest.status === 'checked-in' ? 'Active Stay' : 'Checked Out' %>
          </span>
        </p>
      </section>

      <main class="details-grid">
        <div class="left-column">
          <h3 class="section-title">Guest Information</h3>
          <table class="info-table">
            <tr>
              <td class="label">Full Name</td>
              <td><%= guest.fullName %></td>
            </tr>
            <tr>
              <td class="label">Phone Number</td>
              <td><%= guest.phone %></td>
            </tr>
            <tr>
              <td class="label">Email Address</td>
              <td><%= guest.email || 'N/A' %></td>
            </tr>
            <tr>
              <td class="label">CNIC Number</td>
              <td><%= guest.cnic %></td>
            </tr>
            <tr>
              <td class="label">Occupancy</td>
              <td>
                <%= guest.adults || 1 %> Adults, 
                <%= guest.infants || 0 %> Infants
              </td>
            </tr>
          </table>

          <div class="room-details">
            <h3 class="section-title">Room Details</h3>
            <p>
              <b>Room <%= guest.room.roomNumber %></b> •
              <%= guest.room.bedType %> •
              <%= guest.room.category %> •
              <%= guest.room.view %>
            </p>
            <p><b>Rate:</b> Rs<%= guest.room.rate.toLocaleString() %>/night</p>
          </div>

          <div class="payment-details">
            <h3 class="section-title">Primary Payment Method</h3>
            <p style="text-transform: capitalize"><%= guest.paymentMethod %></p>
          </div>
        </div>

        <div class="right-column">
          <h3 class="section-title">Stay Information</h3>
          <table class="info-table">
            <tr>
              <td class="label">Check-in Date</td>
              <td><%= new Date(guest.checkInAt).toLocaleDateString() %></td>
            </tr>
            <tr>
              <td class="label">Check-out Date</td>
              <td>
                <%= guest.checkOutAt ? new Date(guest.checkOutAt).toLocaleDateString() : 'N/A' %>
              </td>
            </tr>
            <tr>
              <td class="label">Duration</td>
              <td><%= guest.stayDuration %> night(s)</td>
            </tr>
          </table>

          <div class="billing-summary" style="margin-top: 20px">
            <h3 class="section-title">Billing Summary</h3>
            <table>
              <!-- Line items -->
              <% invoice.items.forEach(function(item) { %>
              <tr>
                <td><%= item.description %> (<%= item.quantity %>)</td>
                <td class="amount">Rs<%= item.total.toLocaleString() %></td>
              </tr>
              <% }) %>

              <!-- Subtotal -->
              <tr>
                <td>Subtotal</td>
                <td class="amount">Rs<%= invoice.subtotal.toLocaleString() %></td>
              </tr>

              <!-- Discounts -->
              <% if (invoice.discountAmount > 0) { %>
              <tr>
                <td>Standard Discount</td>
                <td class="amount" style="color: red">
                  -Rs<%= invoice.discountAmount.toLocaleString() %>
                </td>
              </tr>
              <% } %>

              <% if (invoice.additionaldiscount > 0) { %>
              <tr>
                <td>Additional Discount</td>
                <td class="amount" style="color: red">
                  -Rs<%= invoice.additionaldiscount.toLocaleString() %>
                </td>
              </tr>
              <% } %>

              <!-- Tax -->
              <tr>
                <td>Tax (<%= invoice.taxRate %>%)</td>
                <td class="amount">Rs<%= invoice.taxAmount.toLocaleString() %></td>
              </tr>

              <!-- Grand Total -->
              <tr>
                <td style="font-weight:bold; border-top:1px solid #ddd;">Grand Total</td>
                <td class="amount" style="font-weight:bold; border-top:1px solid #ddd;">
                  Rs<%= grandTotal.toLocaleString() %>
                </td>
              </tr>

              <!-- Paid / Advance -->
              <% if (effectiveAdvance > 0) { %>
              <tr>
                <td>Paid / Advance</td>
                <td class="amount" style="color: green;">
                  -Rs<%= effectiveAdvance.toLocaleString() %>
                </td>
              </tr>
              <% } %>

              <!-- Refunds Issued -->
              <% if (totalRefunded > 0) { %>
              <tr>
                <td>Refunds Issued</td>
                <td class="amount" style="color: red;">
                  -Rs<%= totalRefunded.toLocaleString() %>
                </td>
              </tr>
              <% } %>

              <!-- Refund Due -->
              <% if (refundDue > 0) { %>
              <tr>
                <td style="font-weight:bold; color:#c0392b;">Refund Due</td>
                <td class="amount" style="font-weight:bold; color:#c0392b;">
                  Rs<%= refundDue.toLocaleString() %>
                </td>
              </tr>
              <% } %>

              <!-- Final Balance -->
              <tr class="final-row">
                <td>Balance Due</td>
                <td class="amount" style="color:<%= balanceDue > 0 ? '#c0392b' : '#27ae60' %>;">
                  Rs<%= balanceDue.toLocaleString() %>
                </td>
              </tr>
            </table>
          </div>
        </div>
      </main>

      <footer class="footer">
        <p>Thank you for choosing HSQ Towers</p>
        <p>For any inquiries, please contact our reception desk.</p>
        <% if (balanceDue === 0) { %>
          <p style="margin-top: 10px; font-weight: bold; color: green; border: 2px solid green; display: inline-block; padding: 5px 15px; border-radius: 4px;">
            PAID IN FULL
          </p>
        <% } %>
      </footer>
    </div>
  </body>
</html>